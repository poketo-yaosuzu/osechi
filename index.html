<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãŠã›ã¡äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ </title>
<style>
body{font-family:sans-serif;margin:0;padding:0;background:#f5f5f5;color:#333;}
.container{max-width:480px;margin:auto;padding:10px;}
h2{text-align:center;margin:10px 0;}
button{padding:10px 15px;margin:5px;border:none;border-radius:6px;cursor:pointer;font-size:1em;}
button:hover{opacity:0.9;}
.step{display:none;}
.step.active{display:block;}
.store-btn{display:block;width:100%;margin:10px 0;background:#00c300;color:#fff;font-weight:bold;border-radius:10px;padding:15px;font-size:1.1em;box-shadow:0 2px 4px rgba(0,0,0,0.1);}
.menu-card{border:1px solid #ddd;border-radius:12px;padding:10px;margin:12px 0;background:#fff;position:relative;box-shadow:0 2px 6px rgba(0,0,0,0.15);}
.menu-card img{width:100%;border-radius:12px;cursor:pointer;}
.menu-card h3{margin:8px 0 4px;}
.menu-card p{margin:2px 0;font-size:0.9em;color:#555;}
.badge{position:absolute;top:8px;right:8px;background:red;color:#fff;padding:3px 6px;font-size:0.75em;border-radius:4px;}
.qty-control{display:flex;align-items:center;justify-content:center;margin-top:5px;}
.qty-btn{width:36px;height:36px;background:#eee;font-size:1.2em;line-height:36px;text-align:center;border-radius:6px;cursor:pointer;margin:0 5px;}
.qty-display{min-width:24px;text-align:center;font-weight:bold;font-size:1em;}
#step3 label{display:block;margin-bottom:15px;font-size:0.9em;color:#555;}
#step3 input,#step3 textarea,#step3 select{width:100%;padding:12px 12px;border:1px solid #ccc;border-radius:12px;box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);font-size:1em;margin-top:5px;box-sizing:border-box;}
#step3 textarea{resize:none;min-height:80px;}
#step3 button{width:48%;margin:5px 1%;background:#00c300;color:#fff;font-weight:bold;border-radius:12px;padding:12px;font-size:1em;cursor:pointer;border:none;transition:0.2s;}
#step3 button:hover{opacity:0.9;}
#step3 .btn-back{background:#ccc;color:#333;}
#imageModal,#sendingModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;justify-content:center;align-items:center;z-index:1000;}
#imageModal{background:rgba(0,0,0,0.8);}
#sendingModal{background:rgba(0,0,0,0.5);color:#fff;font-size:1.2em;}
#modalContent{position:relative;}
#modalImg{max-width:90vw;max-height:80vh;border-radius:8px;}
#modalCaption{color:#fff;text-align:center;margin-top:5px;}
#modalClose{position:absolute;top:-10px;right:-10px;background:#fff;color:#000;border-radius:50%;width:24px;height:24px;text-align:center;line-height:24px;cursor:pointer;font-weight:bold;}
#step4{text-align:center;}
.thanks-card{background:#eaffea;border-radius:16px;box-shadow:0 4px 8px rgba(0,0,0,0.1);padding:25px;margin:40px auto;max-width:420px;}
.thanks-card h2{color:#00c300;margin-bottom:10px;}
.thanks-card p{font-size:0.95em;margin-bottom:15px;}
.summary{text-align:left;background:#fff;border-radius:12px;padding:12px;margin-bottom:20px;line-height:1.6em;font-size:0.9em;box-shadow: inset 0 1px 4px rgba(0,0,0,0.05);}
#backToLINE{background:#00c300;color:#fff;font-weight:bold;border-radius:10px;padding:12px 20px;border:none;cursor:pointer;font-size:1em;}
#backToLINE:hover{opacity:0.9;}
#summaryBox table {width:100%;border-collapse: collapse;margin-top: 8px;font-size: 0.9em;}
#summaryBox th, #summaryBox td {border:1px solid #ddd;padding:6px 8px;text-align:left;}
#summaryBox th {background:#f1f1f1;}
#summaryBox td {vertical-align: middle;}
@media screen and (max-width:480px) {
  #summaryBox table,#summaryBox th,#summaryBox td {font-size:0.85em;}
  #summaryBox th,#summaryBox td {padding:4px 6px;}
}
</style>
</head>
<body>
<div class="container">

<!-- ã‚¹ãƒ†ãƒƒãƒ—1 -->
<div id="step1" class="step active">
  <h2>ã”åˆ©ç”¨åº—èˆ—ã‚’é¸æŠ</h2>
  <button class="store-btn" data-store="ãƒã‚±ãƒƒãƒˆåº—">ãƒã‚±ãƒƒãƒˆåº—</button>
  <button class="store-btn" data-store="ã‚¢ãƒƒãƒ—ãƒ†ã‚£åº—">ã‚¢ãƒƒãƒ—ãƒ†ã‚£åº—</button>
  <button class="store-btn" data-store="ã‚­ãƒ©ãƒ©åº—">ã‚­ãƒ©ãƒ©åº—</button>
</div>

<!-- ã‚¹ãƒ†ãƒƒãƒ—2 -->
<div id="step2" class="step">
  <h2 id="menuTitle"></h2>
  <div id="menuList"></div>
  <button id="backToStep1">æˆ»ã‚‹</button>
  <button id="toStep3">æ¬¡ã¸</button>
</div>

<!-- ã‚¹ãƒ†ãƒƒãƒ—3 -->
<div id="step3" class="step">
  <h2>ãŠå®¢æ§˜æƒ…å ±</h2>
  <label>ãŠåå‰<input type="text" id="customerName" placeholder="ä¾‹ï¼šå±±ç”°å¤ªéƒ"></label>
  <label>é›»è©±ç•ªå·<input type="tel" id="customerTel" placeholder="ä¾‹ï¼š090-1234-5678"></label>
  <label>å—ä»˜æ—¥ï¼ˆé¸ã¹ã¾ã›ã‚“ï¼‰<input type="text" id="receiveDate" readonly></label>
  <label>å—å–æ™‚é–“ï¼ˆ11ï¼š00ï½18ï¼š00ã¾ã§ã®30åˆ†åˆ»ã¿ã§ã™ï¼‰<select id="receiveTime"></select></label>
  <label>å‚™è€ƒ<textarea id="customerNote" placeholder="ãŠä¼ãˆã—ãŸã„äº‹ãŒã‚ã‚Œã°è¨˜å…¥ä¸‹ã•ã„"></textarea></label>
  <div style="display:flex;justify-content:space-between;">
    <button id="backToStep2" class="btn-back">æˆ»ã‚‹</button>
    <button id="confirmReservation">ç¢ºå®š</button>
  </div>
</div>

<!-- ã‚¹ãƒ†ãƒƒãƒ—4 -->
<div id="step4" class="step">
  <div class="thanks-card">
    <h2>ğŸ‰ ã”äºˆç´„ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼</h2>
    <p>ä»¥ä¸‹ã®å†…å®¹ã§å—ä»˜ã„ãŸã—ã¾ã—ãŸã€‚</p>
    <div class="summary" id="summaryBox"></div>
    <p>å¤‰æ›´ãªã©ã‚ã‚Œã°ã€äºˆç´„åº—èˆ—ã¾ã§ç›´æ¥é€£çµ¡ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚</p>
    <button id="backToLINE">LINEã¸æˆ»ã‚‹</button>
  </div>
</div>

</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="imageModal">
  <div id="modalContent">
    <span id="modalClose">Ã—</span>
    <img id="modalImg" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" alt="">
    <div id="modalCaption"></div>
  </div>
</div>

<!-- é€ä¿¡ä¸­ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="sendingModal">é€ä¿¡ä¸­â€¦</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
const LIFF_ID = "2008417031-yLP1bOMR"; 
const GAS_URL = "https://script.google.com/macros/s/AKfycbwvcHKWuXTZXDssjwskN43tsGivXt3TR8miGH1BID5hOg2MxHZwv8tYT0--QWVNpib8MQ/exec"; 
let selectedStore = "";
const TAX_RATE = 0.08;
const menus = [
  {id:1,name:"å’Œãƒ»æ´‹ï¼‘æ®µé‡ ã¡ã¨ã›",price:8800,discount:true,description:"å°‘äººæ•°ã§ã‚‚æ¥½ã—ã‚ã‚‹å“æ•°è±Šå¯Œãªä¸€å“",img:"img/chitose.jpg"},
  {id:2,name:"å’Œãƒ»æ´‹ï¼’æ®µé‡ ã²ã®ã§",price:15800,discount:true,description:"å®¶æ—ã¿ã‚“ãªã§å¤§æº€è¶³ã€‚å®šç•ªã¨å¤šå½©ãªæ–™ç†ã®äºŒæ®µé‡",img:"img/hinode.jpg"}
];
function withTax(price){ return Math.round(price*(1+TAX_RATE)); }
function formatYen(price){ return `Â¥${price.toLocaleString()}`; }
function formatWareki(date){const y=date.getFullYear()-2018; const wYear="R"+y; const month=date.getMonth()+1; const day=date.getDate(); const weekdays=["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"]; return `${wYear}å¹´${month}æœˆ${day}æ—¥ï¼ˆ${weekdays[date.getDay()]}ï¼‰`; }
function formatTimeHM(timeStr){ const [h,m]=timeStr.split(":"); return `${parseInt(h)}æ™‚${parseInt(m)}åˆ†`; }

// LIFFåˆæœŸåŒ–ï¼ˆãƒ†ã‚¹ãƒˆç”¨ã«å›ºå®šIDã‚’ä½¿ç”¨ï¼‰
let liffUserId = "";

async function initLIFF() {
  try {
    await liff.init({ liffId: LIFF_ID });

    if (!liff.isLoggedIn()) {
      // ãƒ­ã‚°ã‚¤ãƒ³å¾Œã«ã“ã®ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹ã®ã§ return ã§å‡¦ç†ã‚’æ­¢ã‚ã‚‹
      liff.login();
      return;
    }

    // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ãªã‚‰ User ID ã‚’å–å¾—
    const profile = await liff.getProfile();
    liffUserId = profile.userId;
    console.log("LIFF User ID:", liffUserId);

    if (!liffUserId) {
      alert("LINEãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒå–å¾—ã§ãã¾ã›ã‚“ã€‚LINEã‚¢ãƒ—ãƒªã‹ã‚‰é–‹ã„ã¦ãã ã•ã„ã€‚");
    }

  } catch (err) {
    console.error("LIFFåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", err);
    alert("LIFFåˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚");
  }
}

window.addEventListener("load", initLIFF);

// HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°
function escapeHTML(str){ return str.replace(/[&<>\"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":'&#39;'}[m])); }
  
// --------------------- ã‚¹ãƒ†ãƒƒãƒ—1 ---------------------
document.querySelectorAll(".store-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    selectedStore = btn.dataset.store;
    document.getElementById("step1").classList.remove("active");
    document.getElementById("step2").classList.add("active");
    renderMenuStep2();
  });
});
// --------------------- ã‚¹ãƒ†ãƒƒãƒ—2 ---------------------
function renderMenuStep2() {
  document.getElementById("menuTitle").textContent = selectedStore + "ã§ã”äºˆç´„";
  const menuList = document.getElementById("menuList");
  menuList.innerHTML = "";

  menus.forEach((menu, index) => {
    const now = new Date();
    const earlyDiscountEnd = new Date(now.getFullYear(), 10, 30);
    const discountedPrice = (menu.discount && now <= earlyDiscountEnd) ? Math.round(menu.price * 0.95) : menu.price;

    const card = document.createElement("div");
    card.className = "menu-card";
    card.innerHTML = `
      <img src="${menu.img}" alt="${menu.name}">
      <h3>${menu.name}</h3>
      <p>${menu.description}</p>
      <p>æœ¬ä½“ä¾¡æ ¼: ${formatYen(menu.price)}<br>
         æ—©å‰²ä¾¡æ ¼: <span style="color:red;">${formatYen(discountedPrice)}</span><br>
         ç¨è¾¼: ${formatYen(withTax(discountedPrice))}</p>
      <div class="qty-control">
        <div class="qty-btn" data-action="minus">âˆ’</div>
        <div class="qty-display">0</div>
        <div class="qty-btn" data-action="plus">ï¼‹</div>
      </div>
      ${menu.discount && now <= earlyDiscountEnd ? '<div class="badge">11æœˆ30æ—¥(æ—¥)ã¾ã§æ—©å‰²5%å¼•ãä¸­</div>' : ''}
    `;
    menuList.appendChild(card);

    // æ•°é‡ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
    card.querySelectorAll(".qty-btn").forEach(qbtn => {
      qbtn.addEventListener("click", () => {
        const display = card.querySelector(".qty-display");
        let val = parseInt(display.textContent);
        val = qbtn.dataset.action === "plus" ? val + 1 : Math.max(0, val - 1);
        display.textContent = val;
      });
    });

    // ç”»åƒã‚¯ãƒªãƒƒã‚¯ã§ãƒ¢ãƒ¼ãƒ€ãƒ«
    card.querySelector("img").addEventListener("click", () => {
      document.getElementById("modalImg").src = menu.img;
      document.getElementById("modalCaption").textContent = `${menu.name}\n${menu.description}`;
      document.getElementById("imageModal").style.display = "flex";
    });
  }); // â† ã“ã‚ŒãŒ menus.forEach ã®é–‰ã˜

  // æˆ»ã‚‹ãƒ»æ¬¡ã¸ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆã¯ renderMenuStep2 ã®å¤–ã§ OK
  document.getElementById("backToStep1").addEventListener("click", () => {
    document.getElementById("step2").classList.remove("active");
    document.getElementById("step1").classList.add("active");
  });

  document.getElementById("toStep3").addEventListener("click", () => {
    const totalQty = Array.from(document.querySelectorAll("#step2 .menu-card .qty-display"))
                          .reduce((sum, el) => sum + parseInt(el.textContent), 0);
    if (totalQty === 0) { alert("1ã¤ä»¥ä¸Šé¸ã‚“ã§ãã ã•ã„"); return; }
    document.getElementById("step2").classList.remove("active");
    document.getElementById("step3").classList.add("active");
    renderStep3();
  });
} // â† ã“ã‚ŒãŒ renderMenuStep2 ã®é–‰ã˜

// --------------------- ã‚¹ãƒ†ãƒƒãƒ—3 ---------------------
function renderStep3(){
  const now=new Date();
  const receiveDate=new Date(now.getFullYear(),11,31);
  document.getElementById("receiveDate").value=formatWareki(receiveDate);

  const select=document.getElementById("receiveTime");
  select.innerHTML="";
  for(let h=11;h<=18;h++){
    ["00","30"].forEach(m=>{
      if(h===18 && m==="30") return;
      const opt=document.createElement("option");
      opt.value=`${h.toString().padStart(2,"0")}:${m}`;
      opt.textContent=formatTimeHM(opt.value);
      select.appendChild(opt);
    });
  }
}

document.getElementById("backToStep2").addEventListener("click",()=>{
  document.getElementById("step3").classList.remove("active");
  document.getElementById("step2").classList.add("active");
});

// --------------------- ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹ ---------------------
document.getElementById("modalClose").addEventListener("click",()=>{ document.getElementById("imageModal").style.display="none"; });

// --------------------- ç¢ºå®šãƒœã‚¿ãƒ³ ---------------------
document.getElementById("confirmReservation").addEventListener("click", async () => {
  if (!liffUserId) { alert("LINEãƒ­ã‚°ã‚¤ãƒ³ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚"); return; }
  const sendingModal = document.getElementById("sendingModal");
  sendingModal.style.display = "flex";

  try {
    const name = document.getElementById("customerName").value.trim();
    const tel = document.getElementById("customerTel").value.trim();
    const store = selectedStore;
    const note = document.getElementById("customerNote").value.trim();
    const dateVal = document.getElementById("receiveDate").value;
    const timeVal = document.getElementById("receiveTime").value;

    if (!name || !tel || !dateVal || !timeVal) { alert("ãŠåå‰ã€é›»è©±ç•ªå·ã€å—å–æ—¥ã€å—å–æ™‚é–“ã¯å¿…é ˆã§ã™"); sendingModal.style.display = "none"; return; }

    let menuSummaryText = "";
    let totalPrice = 0;
    const now = new Date();
    const earlyDiscountEnd = new Date(now.getFullYear(), 10, 30);

    const menuCards = document.querySelectorAll("#step2 .menu-card");
    menuCards.forEach((card, index) => {
      const qty = parseInt(card.querySelector(".qty-display").textContent);
      if (qty > 0) {
        const menu = menus[index];
        const price = (menu.discount && now <= earlyDiscountEnd) ? Math.round(menu.price * 0.95) : menu.price;
        totalPrice += price * qty;
       menuSummaryText += `${menu.name} Ã— ${qty}\n`
      }
    });

    if (!menuSummaryText) { alert("1ã¤ä»¥ä¸Šå•†å“ã‚’é¸ã‚“ã§ãã ã•ã„"); sendingModal.style.display = "none"; return; }

    const totalPriceWithTax = Math.round(totalPrice * (1 + TAX_RATE));

    const payload = { name, tel, store, date: dateVal, time: timeVal, menu: menuSummaryText.trim(), total: totalPrice, totalWithTax: totalPriceWithTax, note, userId: liffUserId };

    const res = await fetch(GAS_URL, { method:"POST", headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"}, body: new URLSearchParams(payload) });
    const text = await res.text();
    console.log("GAS ç”Ÿãƒ¬ã‚¹ãƒãƒ³ã‚¹:", text);
    let result; try { result = JSON.parse(text); } catch { throw new Error("GASã®å¿œç­”ãŒä¸æ­£ã§ã™"); }

    if (result.result==="success") {
      console.log("ğŸ“Œ Step4 ã«ç§»è¡Œã™ã‚‹å‡¦ç†ãŒå‘¼ã°ã‚ŒãŸï¼");
      sendingModal.style.display="none";
      document.getElementById("step3").classList.remove("active");
      document.getElementById("step4").classList.add("active");
      document.getElementById("summaryBox").innerHTML = 
      menuSummaryText.replace(/\n/g, "<br>");
    } else { throw new Error(result.message || "é€ä¿¡ã‚¨ãƒ©ãƒ¼"); }

  } catch (err) { console.error("é€ä¿¡ã‚¨ãƒ©ãƒ¼:", err); sendingModal.style.display = "none"; alert("é€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚"); }
});

// --------------------- LINEã¸æˆ»ã‚‹ ---------------------
document.getElementById("backToLINE").addEventListener("click", () => { if (liff && liff.isInClient()) { liff.closeWindow(); } else { alert("LINEã‚¢ãƒ—ãƒªã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„"); } });
</script>
</body>
</html>
