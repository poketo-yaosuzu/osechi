<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>おせちご予約フォーム（LINE風・ギャラリー式）</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    /* --- LINE風シンプルUI --- */
    :root{
      --line-green:#06c755;
      --bg:#f1f3f4;
      --card:#ffffff;
      --muted:#8a8f93;
      --accent:#e9f7ee;
      --danger:#ff6b6b;
    }
    *{box-sizing:border-box}
    body{font-family:"Helvetica","Noto Sans JP",sans-serif;background:var(--bg);margin:0;padding:16px;-webkit-font-smoothing:antialiased;}
    .wrap{max-width:540px;margin:0 auto;}
    header{display:flex;align-items:center;gap:12px;margin-bottom:12px;}
    .logo{width:90px;height:44px;border-radius:10px;background:var(--line-green);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;}
    h1{font-size:18px;margin:0}
    .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,0.06);margin-bottom:14px;}
    label.small{display:block;color:var(--muted);font-size:13px;margin-bottom:8px}
    input[type="text"], input[type="tel"], textarea, select {width:100%;padding:10px;border-radius:10px;border:1px solid #e3e6e8;font-size:15px;background:#fff;}
    .two-col{display:flex;gap:8px}.two-col>*{flex:1;}
    .gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:10px;margin-top:8px}
    .product-card{border-radius:12px;background:#fff;border:1px solid #eef2f1;overflow:hidden;display:flex;flex-direction:column;transition:transform .12s ease, box-shadow .12s ease;cursor:pointer}
    .product-card:hover{transform:translateY(-4px); box-shadow:0 10px 22px rgba(0,0,0,0.06)}
    .product-media{height:140px;background:#eee;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .product-media img{width:100%;height:100%;object-fit:cover;display:block}
    .product-body{padding:10px;display:flex;gap:10px;align-items:flex-start}
    .product-info{flex:1}
    .product-title{font-weight:700;margin:0 0 6px 0;display:flex;justify-content:space-between;align-items:center}
    .product-desc{margin:0;color:var(--muted);font-size:13px;line-height:1.3}
    .product-meta{margin-top:8px; display:flex; align-items:center; justify-content:space-between; gap:10px}
    .price{font-weight:800}
    .badge{background:var(--accent);color:#0c6b32;font-weight:700;font-size:12px;padding:4px 6px;border-radius:999px}
    .qty-wrap{display:flex;align-items:center;gap:6px;margin-top:6px}
    .qty-btn{width:32px;height:32px;border-radius:8px;border:1px solid #ddd;background:#fff;cursor:pointer}
    .qty-input{width:56px;text-align:center;padding:6px;border-radius:8px;border:1px solid #e0e0e0}
    .cart{margin-top:12px;background:#fff;border-radius:12px;padding:10px;box-shadow:0 4px 12px rgba(0,0,0,0.05)}
    .cart-item{display:flex;justify-content:space-between;align-items:center;padding:4px 0;border-bottom:1px solid #eee}
    .cart-item:last-child{border-bottom:none}
    .cart-remove{color:var(--danger);cursor:pointer;font-size:14px}
    .summary{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .summary-row{display:flex;justify-content:space-between;align-items:center}
    .total{font-size:20px;font-weight:800}
    .submit-btn{background:var(--line-green);color:#fff;padding:12px;border-radius:10px;border:none;width:100%;font-size:16px;cursor:pointer;margin-top:10px}
    footer{text-align:center;color:var(--muted);font-size:13px;margin-top:12px;}
    .note{font-size:13px;color:var(--muted);margin-top:6px}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">YAOSUZU</div>
    <div>
      <h1>おせちご予約フォーム</h1>
      <div style="font-size:13px;color:#666">受取日は<strong>12月31日となります</strong>（この日に限ります）</div>
    </div>
  </header>

  <form id="reservationForm" class="card" autocomplete="off">
    <div style="display:flex; gap:8px; margin-bottom:10px">
      <input type="text" id="name" placeholder="お名前（必須）" required>様
      <input type="tel" id="phone" placeholder="電話番号（必須）" required>
    </div>

    <label class="small">受取店舗　※この店舗でお支払いとなります</label>
    <select id="store" required>
      <option value="">選択してください</option>
      <option value="ポケット店">ポケット店</option>
      <option value="アップティ店">アップティ店</option>
      <option value="キララ店">キララ店</option>
    </select>

    <label class="small">受取時間　※10:00~18:00までの30分刻みです</label>
    <select id="pickupTime" required></select>

    <div style="margin-top:12px; display:flex; justify-content:space-between; align-items:center">
      <div style="font-weight:700">商品を選ぶ</div>
      <div id="discountInfo" style="font-size:13px;color:#0a7a3b"></div>
    </div>
    <div class="gallery" id="gallery"></div>

    <div class="cart" id="cart"></div>

    <div class="summary">
      <div class="summary-row"><div>合計金額：</div><div class="total"><span id="total">0</span>円</div></div>
      <div class="note">※価格は早割り適用後の金額を表示します。消費税（８％）は別途かかります。</div>
    </div>

    <label class="small" style="margin-top:12px">備考</label>
    <textarea id="memo" rows="3" placeholder="ご要望などがあれば記入してください"></textarea>

    <button type="submit" class="submit-btn">送信する</button>
  </form>

  <footer>©️ スーパーヤオスズ</footer>
</div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbwvcHKWuXTZXDssjwskN43tsGivXt3TR8miGH1BID5hOg2MxHZwv8tYT0--QWVNpib8MQ/exec";
const LIFF_ID = "2008417031-yLP1bOMR";

// 商品データ
const PRODUCTS = [
  { name: "ちとせ", price: 8800, img: "img/chitose.jpg", desc: "和・洋一段重：少人数でも楽しめる品数豊富な一品。", earlyDiscount: 0.05, discountUntil: "2025-11-30" },
  { name: "ひので", price: 15800, img: "img/hinode.jpg", desc: "和・洋二段重：家族みんなで大満足。定番と多彩な料理の二段重。", earlyDiscount: 0.05, discountUntil: "2025-11-30" }
];

const gallery = document.getElementById('gallery');
const cartEl = document.getElementById('cart');
const totalEl = document.getElementById('total');
const discountInfo = document.getElementById('discountInfo');
const pickupTimeEl = document.getElementById('pickupTime');
const fixedPickupDate = "2025-12-31";

let userId = "";
let cart = [];

// 受取時間 10:00-18:00 30分刻み
function renderPickupTimes(){
  for(let h=10; h<=18; h++){
    ["00","30"].forEach(m=>{
      if(h===18 && m==="30") return;
      const opt = document.createElement("option");
      opt.value = `${String(h).padStart(2,"0")}:${m}`;
      opt.textContent = `${h}:${m}`;
      pickupTimeEl.appendChild(opt);
    });
  }
}

// ギャラリー
function formatLabelDate(isoDate){
  const d = new Date(isoDate+"T00:00:00");
  const jpDays = ["日","月","火","水","木","金","土"];
  return `${d.getMonth()+1}月${d.getDate()}日(${jpDays[d.getDay()]})`;
}
function isEarlyDiscountActive(untilIso){
  const today = new Date();
  const t = new Date(today.getFullYear(),today.getMonth(),today.getDate());
  const uParts = untilIso.split("-");
  const u = new Date(Number(uParts[0]),Number(uParts[1])-1,Number(uParts[2]));
  return t<=u;
}

function renderGallery(){
  gallery.innerHTML="";
  PRODUCTS.forEach((p,idx)=>{
    const card = document.createElement("div");
    card.className="product-card";
    const media=document.createElement("div"); media.className="product-media";
    const img=document.createElement("img"); img.src=p.img; img.alt=p.name;
    img.addEventListener('click',(e)=>{ e.stopPropagation(); Swal.fire({imageUrl:p.img,imageAlt:p.name,showCloseButton:true,showConfirmButton:false}); });
    media.appendChild(img);
    const body=document.createElement("div"); body.className="product-body";
    const info=document.createElement("div"); info.className="product-info";
    const title=document.createElement("div"); title.className="product-title"; title.textContent=p.name+" "+p.price.toLocaleString()+"円";
    const desc=document.createElement("p"); desc.className="product-desc"; desc.textContent=p.desc;
    const meta=document.createElement("div"); meta.className="product-meta";
    const badge=document.createElement("div"); badge.className="badge";
    const earlyActive=isEarlyDiscountActive(p.discountUntil);
    if(earlyActive){ badge.textContent=`${formatLabelDate(p.discountUntil)}まで表示価格より${Math.round(p.earlyDiscount*100)}％OFF`; meta.appendChild(badge);}
    const qtyWrap=document.createElement("div"); qtyWrap.className="qty-wrap";
    const qtyInput=document.createElement("input"); qtyInput.type="number"; qtyInput.value=1; qtyInput.min=1; qtyInput.className="qty-input";
    const addBtn=document.createElement("button"); addBtn.type="button"; addBtn.textContent="追加"; addBtn.className="qty-btn";
    addBtn.addEventListener("click",(e)=>{ e.stopPropagation(); addToCart(p,parseInt(qtyInput.value||1),earlyActive?Math.floor(p.price*(1-p.earlyDiscount)):p.price); qtyInput.value=1; });
    qtyWrap.appendChild(qtyInput); qtyWrap.appendChild(addBtn);
    info.appendChild(title); info.appendChild(desc); info.appendChild(meta);
    body.appendChild(info); body.appendChild(qtyWrap);
    card.appendChild(media); card.appendChild(body);
    gallery.appendChild(card);
  });
}

function addToCart(p,qty,price){
  const idx = cart.findIndex(c=>c.name===p.name);
  if(idx>=0){ cart[idx].qty+=qty; cart[idx].price=price; }
  else{ cart.push({name:p.name,qty,price}); }
  renderCart();
}
function removeFromCart(name){
  cart = cart.filter(c=>c.name!==name);
  renderCart();
}
function renderCart(){
  cartEl.innerHTML="";
  cart.forEach(c=>{
    const div=document.createElement("div"); div.className="cart-item";
    div.innerHTML=`${c.name} ×${c.qty} <span class="cart-remove" data-name="${c.name}">削除</span> <span>${c.price.toLocaleString()}円</span>`;
    cartEl.appendChild(div);
  });
  cartEl.querySelectorAll(".cart-remove").forEach(btn=>{
    btn.addEventListener("click",()=>removeFromCart(btn.dataset.name));
  });
  updateTotal();
}
function updateTotal(){
  const sum = cart.reduce((s,c)=>s+c.price*c.qty,0);
  totalEl.textContent=sum.toLocaleString();
}

// 初期描画
renderPickupTimes();
renderGallery();
updateTotal();
if(PRODUCTS.some(p=>isEarlyDiscountActive(p.discountUntil))){
  discountInfo.textContent=`${formatLabelDate(PRODUCTS[0].discountUntil)}まで表示価格より${Math.round(PRODUCTS[0].earlyDiscount*100)}％OFF`;
}

// LIFF初期化
(async()=>{try{if(!LIFF_ID||LIFF_ID==="YOUR_LIFF_ID")return;await liff.init({liffId:LIFF_ID});if(!liff.isLoggedIn())liff.login(); const profile=await liff.getProfile();userId=profile.userId||"";}catch(err){console.warn("LIFF init error:",err);}})();

// 送信処理
document.getElementById("reservationForm").addEventListener("submit", async(ev)=>{
  ev.preventDefault();
  if(cart.length===0){ Swal.fire({icon:'warning',title:'商品を1つ以上追加してください'}); return; }
  const name=document.getElementById("name").value.trim();
  const phone=document.getElementById("phone").value.trim();
  const store=document.getElementById("store").value;
  const pickupTime=document.getElementById("pickupTime").value;
  if(!name||!phone||!store||!pickupTime){ Swal.fire({icon:'warning',title:'必須項目を入力してください'}); return; }

  const productsText = cart.map(c=>`${c.name} ×${c.qty}（単価 ${c.price.toLocaleString()}円）`).join("\n");
  const total = cart.reduce((s,c)=>s+c.price*c.qty,0);

  Swal.fire({icon:'question',title:'内容を確認してください',html:`<pre>${productsText}</pre><br>合計: ${total.toLocaleString()}円`,showCancelButton:true,confirmButtonText:'送信',cancelButtonText:'キャンセル'}).then(async(result)=>{
    if(!result.isConfirmed) return;
    const payload={name,phone,store,pickupDate:fixedPickupDate,pickupTime,products:productsText,total:String(total),memo:document.getElementById("memo").value||"",userId};
    try{
      Swal.showLoading();
      const res=await fetch(GAS_URL,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:new URLSearchParams(payload)});
      const resultJson=await res.json();
      Swal.close();
      if(resultJson.result==='success'){ Swal.fire({icon:'success',title:'予約を受け付けました'}); cart=[]; renderCart(); document.getElementById("reservationForm").reset();}
      else{ Swal.fire({icon:'error',title:'送信エラー',text:resultJson.message||'サーバーエラー'}); }
    }catch(err){ Swal.close(); Swal.fire({icon:'error',title:'通信エラー',text:err.message||String(err)}); }
  });
});
</script>
</body>
</html>
