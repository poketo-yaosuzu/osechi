<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãŠã›ã¡äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ </title>
<style>
body{font-family:sans-serif;margin:0;padding:0;background:#f5f5f5;color:#333;}
.container{max-width:480px;margin:auto;padding:10px;}
h2{text-align:center;margin:10px 0;}

/* å…±é€šã‚¹ãƒ†ãƒƒãƒ— */
button{padding:10px 15px;margin:5px;border:none;border-radius:6px;cursor:pointer;font-size:1em;}
button:hover{opacity:0.9;}
.step{display:none;}
.step.active{display:block;}

/* ã‚¹ãƒ†ãƒƒãƒ—1:åº—èˆ—é¸æŠãƒœã‚¿ãƒ³ */
.store-btn{display:block;width:100%;margin:10px 0;background:#00c300;color:#fff;font-weight:bold;border-radius:10px;padding:15px;font-size:1.1em;box-shadow:0 2px 4px rgba(0,0,0,0.1);}

/* ã‚¹ãƒ†ãƒƒãƒ—2:ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚«ãƒ¼ãƒ‰ */
.menu-card{border:1px solid #ddd;border-radius:12px;padding:10px;margin:12px 0;background:#fff;position:relative;box-shadow:0 2px 6px rgba(0,0,0,0.15);}
.menu-card img{width:100%;border-radius:12px;cursor:pointer;}
.menu-card h3{margin:8px 0 4px;}
.menu-card p{margin:2px 0;font-size:0.9em;color:#555;}
.badge{position:absolute;top:8px;right:8px;background:red;color:#fff;padding:3px 6px;font-size:0.75em;border-radius:4px;}
.qty-control{display:flex;align-items:center;justify-content:center;margin-top:5px;}
.qty-btn{width:36px;height:36px;background:#eee;font-size:1.2em;line-height:36px;text-align:center;border-radius:6px;cursor:pointer;margin:0 5px;}
.qty-display{min-width:24px;text-align:center;font-weight:bold;font-size:1em;}

/* ã‚¹ãƒ†ãƒƒãƒ—3:ãŠå®¢æ§˜æƒ…å ±LINEé¢¨ */
#step3 label{display:block;margin-bottom:15px;font-size:0.9em;color:#555;}
#step3 input,#step3 textarea,#step3 select{
  width:100%;
  padding:12px 12px;
  border:1px solid #ccc;
  border-radius:12px;
  box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
  font-size:1em;
  margin-top:5px;
  box-sizing:border-box;
}
#step3 textarea{resize:none;min-height:80px;}
#step3 button{width:48%;margin:5px 1%;background:#00c300;color:#fff;font-weight:bold;border-radius:12px;padding:12px;font-size:1em;cursor:pointer;border:none;transition:0.2s;}
#step3 button:hover{opacity:0.9;}
#step3 .btn-back{background:#ccc;color:#333;}

/* ãƒ¢ãƒ¼ãƒ€ãƒ« */
#imageModal,#sendingModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;justify-content:center;align-items:center;z-index:1000;}
#imageModal{background:rgba(0,0,0,0.8);}
#sendingModal{background:rgba(0,0,0,0.5);color:#fff;font-size:1.2em;}
#modalContent{position:relative;}
#modalImg{max-width:90vw;max-height:80vh;border-radius:8px;}
#modalCaption{color:#fff;text-align:center;margin-top:5px;}
#modalClose{position:absolute;top:-10px;right:-10px;background:#fff;color:#000;border-radius:50%;width:24px;height:24px;text-align:center;line-height:24px;cursor:pointer;font-weight:bold;}

/* ã‚¹ãƒ†ãƒƒãƒ—ï¼”ï¼šLINEé¢¨ã‚µãƒ³ã‚¯ã‚¹ã‚«ãƒ¼ãƒ‰ */
#step4 {
  display: none;
  text-align: center;
}
.thanks-card {
  background: #eaffea;
  border-radius: 16px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  padding: 25px;
  margin: 40px auto;
  max-width: 420px;
}
.thanks-card h2 {
  color: #00c300;
  margin-bottom: 10px;
}
.thanks-card p {
  font-size: 0.95em;
  margin-bottom: 15px;
}
.summary {
  text-align: left;
  background: #fff;
  border-radius: 12px;
  padding: 12px;
  margin-bottom: 20px;
  line-height: 1.6em;
  font-size: 0.9em;
  box-shadow: inset 0 1px 4px rgba(0,0,0,0.05);
}
#backToLINE {
  background: #00c300;
  color: #fff;
  font-weight: bold;
  border-radius: 10px;
  padding: 12px 20px;
  border: none;
  cursor: pointer;
  font-size: 1em;
}
#backToLINE:hover { opacity:0.9; }
</style>
</head>
<body>
<div class="container">

<!-- ã‚¹ãƒ†ãƒƒãƒ—1 -->
<div id="step1" class="step active">
  <h2>ã”åˆ©ç”¨åº—èˆ—ã‚’é¸æŠ</h2>
  <button class="store-btn" data-store="ãƒã‚±ãƒƒãƒˆåº—">ãƒã‚±ãƒƒãƒˆåº—</button>
  <button class="store-btn" data-store="ã‚¢ãƒƒãƒ—ãƒ†ã‚£åº—">ã‚¢ãƒƒãƒ—ãƒ†ã‚£åº—</button>
  <button class="store-btn" data-store="ã‚­ãƒ©ãƒ©åº—">ã‚­ãƒ©ãƒ©åº—</button>
</div>

<!-- ã‚¹ãƒ†ãƒƒãƒ—2 -->
<div id="step2" class="step">
  <h2 id="menuTitle"></h2>
  <div id="menuList"></div>
  <button id="backToStep1">æˆ»ã‚‹</button>
  <button id="toStep3">æ¬¡ã¸</button>
</div>

<!-- ã‚¹ãƒ†ãƒƒãƒ—3 -->
<div id="step3" class="step">
  <h2>ãŠå®¢æ§˜æƒ…å ±</h2>
  <label>ãŠåå‰<input type="text" id="customerName" placeholder="ä¾‹ï¼šå±±ç”°å¤ªéƒ"></label>
  <label>é›»è©±ç•ªå·<input type="tel" id="customerTel" placeholder="ä¾‹ï¼š090-1234-5678"></label>
  <label>å—å–æ—¥<input type="text" id="receiveDate" readonly></label>
  <label>å—å–æ™‚é–“<select id="receiveTime"></select></label>
  <label>å‚™è€ƒ<textarea id="customerNote" placeholder="ä¾‹ï¼šã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ã‚ã‚Š"></textarea></label>
  <div style="display:flex;justify-content:space-between;">
    <button id="backToStep2" class="btn-back">æˆ»ã‚‹</button>
    <button id="confirmReservation">ç¢ºå®š</button>
  </div>
</div>

<!-- ã‚¹ãƒ†ãƒƒãƒ—4 -->
<div id="step4" class="step">
  <div class="thanks-card">
    <h2>ğŸ‰ ã”äºˆç´„ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼</h2>
    <p>ä»¥ä¸‹ã®å†…å®¹ã§å—ä»˜ã„ãŸã—ã¾ã—ãŸã€‚</p>
    <div class="summary" id="summaryBox"></div>
    <button id="backToLINE">LINEã¸æˆ»ã‚‹</button>
  </div>
</div>

</div> <!-- container end -->

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="imageModal">
  <div id="modalContent">
    <span id="modalClose">Ã—</span>
    <img id="modalImg" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" alt="">
    <div id="modalCaption"></div>
  </div>
</div>

<!-- é€ä¿¡ä¸­ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="sendingModal">é€ä¿¡ä¸­â€¦</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
// ------------------ åˆæœŸè¨­å®š ------------------
let selectedStore = "";
const TAX_RATE = 0.08;
const menus = [
  {id:1,name:"å’Œãƒ»æ´‹ï¼‘æ®µé‡ ã¡ã¨ã›",price:8800,discount:true,description:"ä¸€æ®µã®å’Œæ´‹æŠ˜è¡·ãŠã›ã¡",img:"img/chitose.jpg"},
  {id:2,name:"å’Œãƒ»æ´‹ï¼’æ®µé‡ ã²ã®ã§",price:15800,discount:true,description:"äºŒæ®µã®è±ªè¯å’Œæ´‹æŠ˜è¡·ãŠã›ã¡",img:"img/hinode.jpg"}
];

function withTax(price){ return Math.round(price*(1+TAX_RATE)); }
function formatYen(price){ return `Â¥${price.toLocaleString()}`; }
function formatWareki(date){const y=date.getFullYear()-2018; return `R${y}å¹´${date.getMonth()+1}æœˆ${date.getDate()}æ—¥ï¼ˆ${["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"][date.getDay()]}ï¼‰`; }
function formatTimeHM(timeStr){ const [h,m]=timeStr.split(":"); return `${parseInt(h)}æ™‚${parseInt(m)}åˆ†`; }

  liff.init({
  liffId: "2008417031-yLP1bOMR"
}).then(() => {
  console.log("LIFF initialized");
}).catch(err => {
  console.error("LIFF init error", err);
});
  
// ------------------ ã‚¹ãƒ†ãƒƒãƒ—1 ------------------
document.querySelectorAll(".store-btn").forEach(btn=>{
  btn.addEventListener("click",()=>{
    selectedStore = btn.dataset.store;
    document.getElementById("step1").classList.remove("active");
    document.getElementById("step2").classList.add("active");
    renderMenuStep2();
  });
});

// ------------------ ã‚¹ãƒ†ãƒƒãƒ—2 ------------------
function renderMenuStep2(){
  document.getElementById("menuTitle").textContent = selectedStore+"ã®ã”äºˆç´„";
  const menuList=document.getElementById("menuList");
  menuList.innerHTML="";
  menus.forEach((menu,index)=>{
    const now=new Date();
    const earlyDiscountEnd=new Date(now.getFullYear(),10,30);
    const discountedPrice=(menu.discount && now<=earlyDiscountEnd)? Math.round(menu.price*0.95):menu.price;

    const card=document.createElement("div");
    card.className="menu-card";
    card.innerHTML=`
      <img src="${menu.img}" alt="${menu.name}">
      <h3>${menu.name}</h3>
      <p>${menu.description}</p>
      <p>æœ¬ä½“ä¾¡æ ¼: ${formatYen(menu.price)}<br>
         æ—©å‰²ä¾¡æ ¼: <span style="color:red;">${formatYen(discountedPrice)}</span><br>
         ç¨è¾¼: ${formatYen(withTax(discountedPrice))}</p>
      <div class="qty-control">
        <div class="qty-btn" data-action="minus">âˆ’</div>
        <div class="qty-display">0</div>
        <div class="qty-btn" data-action="plus">ï¼‹</div>
      </div>
      ${menu.discount && now<=earlyDiscountEnd?'<div class="badge">11æœˆ30æ—¥(æ—¥)ã¾ã§æ—©å‰²5%å¼•ãä¸­</div>':''}
    `;
    menuList.appendChild(card);

    card.querySelectorAll(".qty-btn").forEach(qbtn=>{
      qbtn.addEventListener("click",()=>{
        const display=card.querySelector(".qty-display");
        let val=parseInt(display.textContent);
        val = qbtn.dataset.action==="plus"?val+1:Math.max(0,val-1);
        display.textContent=val;
      });
    });

    card.querySelector("img").addEventListener("click",()=>{
      document.getElementById("modalImg").src=menu.img;
      document.getElementById("modalCaption").textContent=menu.name+"\n"+menu.description;
      document.getElementById("imageModal").style.display="flex";
    });
  });
}

document.getElementById("backToStep1").addEventListener("click",()=>{
  document.getElementById("step2").classList.remove("active");
  document.getElementById("step1").classList.add("active");
});
document.getElementById("toStep3").addEventListener("click",()=>{
  document.getElementById("step2").classList.remove("active");
  document.getElementById("step3").classList.add("active");
  renderStep3();
});

// ------------------ ã‚¹ãƒ†ãƒƒãƒ—3 ------------------
function renderStep3(){
  const now=new Date();
  const receiveDate=new Date(now.getFullYear(),11,31);
  document.getElementById("receiveDate").value=formatWareki(receiveDate);

  const select=document.getElementById("receiveTime");
  select.innerHTML="";
  for(let h=11;h<=18;h++){
    ["00","30"].forEach(m=>{
      if(h===18 && m==="30") return;
      const opt=document.createElement("option");
      opt.value=`${h.toString().padStart(2,"0")}:${m}`;
      opt.textContent=formatTimeHM(opt.value);
      select.appendChild(opt);
    });
  }
}

document.getElementById("backToStep2").addEventListener("click",()=>{
  document.getElementById("step3").classList.remove("active");
  document.getElementById("step2").classList.add("active");
});

// ------------------ ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹ ------------------
document.getElementById("modalClose").addEventListener("click",()=>{
  document.getElementById("imageModal").style.display="none";
});

// ------------------ ç¢ºå®šãƒœã‚¿ãƒ³ ------------------
document.getElementById("confirmReservation").addEventListener("click", async () => {
  const sendingModal = document.getElementById("sendingModal");
  sendingModal.style.display="flex";

  const name = document.getElementById("customerName").value.trim() + "æ§˜";
  const tel = document.getElementById("customerTel").value.trim();
  const store = selectedStore;
  const note = document.getElementById("customerNote").value.trim();
  const dateVal = document.getElementById("receiveDate").value;
  const timeVal = document.getElementById("receiveTime").value;

  let menuSummary = "";
  menus.forEach((menu,index)=>{
    const qty = parseInt(document.querySelectorAll("#step2 .menu-card .qty-display")[index].textContent);
    if(qty>0){
      menuSummary += `${menu.name} Ã— ${qty}\n`;
    }
  });

  const payload = {
    userId: liff.getContext().userId,
    name,name,
    tel,tel,
    store,store,
    note,note,
    date:dateVal,
    time:timeVal,
    menu:menuSummary
  };

  try{
    await fetch("https://script.google.com/macros/s/AKfycbw7ulRlsbuUG2jW9tYqqZe-cT2yJJpA63tBjKdG66znyOLLDaCS2_Etx1BOJf_oX79MPw/exec",{
      method:"POST",
      body:JSON.stringify(payload),
      headers:{"Content-Type":"application/json"}
    });

    if(liff.isLoggedIn()){
      await liff.sendMessages([{
        type:"text",
        text:`ã”äºˆç´„ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼\n\nåº—èˆ—: ${store}\nå—å–æ—¥: ${dateVal} ${timeVal}\nãŠåå‰: ${name}\né›»è©±: ${tel}\nã”æ³¨æ–‡å†…å®¹:\n${menuSummary}`
      }]);
    }

    sendingModal.style.display="none";
    document.getElementById("step3").classList.remove("active");
    document.getElementById("step4").classList.add("active");

    document.getElementById("summaryBox").innerHTML=`
      <strong>åº—èˆ—ï¼š</strong>${store}<br>
      <strong>ãŠåå‰ï¼š</strong>${name}<br>
      <strong>é›»è©±ç•ªå·ï¼š</strong>${tel}<br>
      <strong>å—å–æ—¥ï¼š</strong>${dateVal} ${formatTimeHM(timeVal)}<br>
      <strong>ã”æ³¨æ–‡ï¼š</strong><br>${menuSummary.replace(/\n/g,"<br>")}
    `;
  }catch(err){
    sendingModal.style.display="none";
    alert("é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
    console.error(err);
  }
});

// LINEã¸æˆ»ã‚‹
document.getElementById("backToLINE").addEventListener("click",()=>{
  if(liff.isInClient()){ liff.closeWindow(); } else { location.reload(); }
});
</script>
</body>
</html>
