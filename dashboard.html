<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ãŠã›ã¡äºˆç´„ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
<style>
body { font-family: "Noto Sans JP", sans-serif; background: #f9fafc; margin: 0; }
.container { max-width: 1000px; margin: 0 auto; padding: 20px; }
h1 { text-align: center; margin-bottom: 20px; }
.filter-buttons { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 20px; }
.filter-btn {
  background: #e0e0e0;
  color: #333;
  border: none;
  border-radius: 8px;
  padding: 8px 16px;
  font-size: 0.95em;
  cursor: pointer;
  transition: all 0.2s;
}
.filter-btn.active {
  background: #00c300;
  color: #fff;
  font-weight: bold;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
.filter-btn:hover { opacity: 0.9; }

button#reloadBtn {
  padding: 8px 14px;
  border: none;
  border-radius: 8px;
  background: #007bff;
  color: #fff;
  cursor: pointer;
  margin-left: 10px;
}
button#reloadBtn:hover { opacity: 0.9; }

table { width: 100%; border-collapse: collapse; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
th, td { border: 1px solid #ddd; padding: 8px; font-size: 0.9em; text-align: left; }
th { background: #f1f1f1; cursor: pointer; }
tr:hover { background: #fafafa; }

/* èª­ã¿è¾¼ã¿ä¸­ãƒ¢ãƒ¼ãƒ€ãƒ« */
#loadingModal {
  display: none;
  position: fixed;
  top:0; left:0;
  width:100%; height:100%;
  background: rgba(0,0,0,0.5);
  color:#fff;
  font-size:1.2em;
  display:flex; /* äºŒé‡æŒ‡å®šãªã®ã§æ•´ç† */
  justify-content:center;
  align-items:center;
  z-index:1000;
}
</style>
</head>
<body>
<div class="container">
  <h1>ğŸ± ãŠã›ã¡äºˆç´„ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>

  <div class="filter-buttons">
    <button class="filter-btn active" data-store="å…¨åº—">å…¨åº—</button>
    <button class="filter-btn" data-store="ãƒã‚±ãƒƒãƒˆåº—">ãƒã‚±ãƒƒãƒˆåº—</button>
    <button class="filter-btn" data-store="ã‚¢ãƒƒãƒ—ãƒ†ã‚£åº—">ã‚¢ãƒƒãƒ—ãƒ†ã‚£åº—</button>
    <button class="filter-btn" data-store="ã‚­ãƒ©ãƒ©åº—">ã‚­ãƒ©ãƒ©åº—</button>
    <button id="reloadBtn">ğŸ”„ æ›´æ–°</button>
  </div>

  <table id="reservationTable">
    <thead>
      <tr>
        <th data-sort="äºˆç´„ç•ªå·">äºˆç´„ç•ªå·</th>
        <th data-sort="ç™»éŒ²æ—¥æ™‚">ç™»éŒ²æ—¥æ™‚</th>
        <th data-sort="åå‰">åå‰</th>
        <th data-sort="å—å–åº—èˆ—">åº—èˆ—</th>
        <th data-sort="å—å–æ—¥">å—å–æ—¥</th>
        <th data-sort="å—å–æ™‚é–“">å—å–æ™‚é–“</th>
        <th data-sort="æ³¨æ–‡å†…å®¹">æ³¨æ–‡å†…å®¹</th>
        <th data-sort="å‚™è€ƒ">å‚™è€ƒ</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- èª­ã¿è¾¼ã¿ä¸­ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="loadingModal">ğŸ”„ èª­ã¿è¾¼ã¿ä¸­â€¦</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzwrh9XpkMVl2osyxAjWq2ZNhlubQ2H8CDLhkgN7LfvYBfzhDOLwjnQtyuH7k_dWQSm9A/exec"; // GAS URL
let reservationData = [];
let currentStore = "å…¨åº—";
let currentSort = { key: "No", asc: true };

const loadingModal = document.getElementById("loadingModal");

// ãƒ‡ãƒ¼ã‚¿å–å¾— + ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
async function fetchData() {
  try {
    loadingModal.style.display = "flex";
    const res = await fetch(API_URL);
    const json = await res.json();
    if(json.result === "success") {
      reservationData = json.data;
    } else {
      alert("ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: " + (json.message || "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼"));
      reservationData = [];
    }
    renderTable(); // fetchå¾Œã«æç”»
  } catch(err) {
    alert("ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err.message);
  } finally {
    loadingModal.style.display = "none";
  }
}


function renderTable() {
  let filtered = reservationData.slice(); // ã‚³ãƒ”ãƒ¼ã—ã¦æ“ä½œ
  if (currentStore !== "å…¨åº—") {
    filtered = filtered.filter(r => r["å—å–åº—èˆ—"] === currentStore);
  }

  const tbody = document.querySelector("#reservationTable tbody");
  tbody.innerHTML = "";

  if (filtered.length === 0) {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="8" style="text-align:center;color:#888;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td>`;
    tbody.appendChild(tr);
    return;
  }

filtered.forEach(r => {
  const tr = document.createElement("tr");
  const dateStr = r["ç™»éŒ²æ—¥æ™‚"] ? new Date(r["ç™»éŒ²æ—¥æ™‚"]) : null;
  tr.innerHTML = `
    <td>${r["äºˆç´„ç•ªå·"] || ""}</td>
    <td>${dateStr ? dateStr.toLocaleString() : ""}</td>
    <td>${r["åå‰"] || ""}</td>
    <td>${r["å—å–åº—èˆ—"] || ""}</td>
    <td>${r["å—å–æ—¥"] || ""}</td>
    <td>${r["å—å–æ™‚é–“"] || ""}</td>
    <td>${r["æ³¨æ–‡å†…å®¹"]?.replace(/\n/g,"<br>") || ""}</td>
    <td>${r["å‚™è€ƒ"] || ""}</td>
  `;
  tbody.appendChild(tr);
});

}



// ãƒ•ã‚£ãƒ«ã‚¿ãƒœã‚¿ãƒ³
document.querySelectorAll(".filter-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".filter-btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    currentStore = btn.dataset.store;
    renderTable();
  });
});

// ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½
document.querySelectorAll("#reservationTable th").forEach(th => {
  th.addEventListener("click", () => {
    const key = th.dataset.sort;
    currentSort.asc = currentSort.key === key ? !currentSort.asc : true;
    currentSort.key = key;

    reservationData.sort((a,b) => {
      let va = a[key] || "";
      let vb = b[key] || "";

      if(key === "ç™»éŒ²æ—¥æ™‚") {
        va = new Date(va);
        vb = new Date(vb);
        return currentSort.asc ? va - vb : vb - va;
      }

      if(key === "å—å–æ™‚é–“") {
        const [hA,mA]=va.split(":").map(Number);
        const [hB,mB]=vb.split(":").map(Number);
        return currentSort.asc ? (hA*60+mA)-(hB*60+mB) : (hB*60+mB)-(hA*60+mA);
      }

      return currentSort.asc
        ? va.toString().localeCompare(vb.toString(), "ja")
        : vb.toString().localeCompare(va.toString(), "ja");
    });

    renderTable();
  });
});

// æ›´æ–°ãƒœã‚¿ãƒ³
document.getElementById("reloadBtn").addEventListener("click", fetchData);

// åˆå›ãƒ­ãƒ¼ãƒ‰
fetchData();
</script>
</body>
</html>
